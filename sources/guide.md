
# 引言
邮件是一个岁月悠久的服务, 在这个行业中, 众多前辈们制定了很多的行业标准. 所以, 想要让您的邮件顺利的送达, **遵循游戏规则** 是非常必要的~o~

## 服务方式

### 邮件类型

**触发邮件**: 在某种场景下, 由事件触发的邮件发送. 比如: 注册激活, 密码找回, 站内通知, 信息确认, 账单寄送等.

**批量邮件**: 商家对会员发送的通知邮件. 比如: 新功能上线, 打折优惠等. 

注意: SendCloud 要求收件地址来源自会员注册, 发送内容是用户主动订阅, 且不带有广告营销性质.

### SendCloud的服务机制

SendCloud 为用户提供了 SMTP 和 WEBAPI 两种调用接口的方式, 用户可以根据业务场景或个人喜好选择任一方式接入

* 用户编写程序, 调用 SendCloud 的接口, 传输邮件数据
* 请求成功之后, SendCloud 会对邮件数据进行处理 ( 排队调度, 速率控制, 变量替换, 追踪 )
* 处理完毕, 邮件会被调度到相应的外发机器「outbound」( 共享IP, 独立IP )
* 最终, 由「outbound」和邮件服务商通讯, 将邮件投递出去

### 通过SMTP接入

使用 SMTP 协议传输数据到 SendCloud 的邮件服务器 ( smtpcloud.sohu.com:25 )

* 用户可以编写程序连接邮件服务器, 发送邮件 
* 用户可以配置客户端连接邮件服务器, 只需修改用户名, 密码和 SMTP 配置即可

### 通过 WEBAPI 接入

WEBAPI 是使用 HTTP 接入 SendCloud 服务的一种方式. 用户可以利用 SendCloud 提供的 HTTP 接口, 调用 SendCloud 的服务. 

目前 WEBAPI 提供了邮件发送 (触发/触发), 域名查询, 个人信息, 地址列表 (CRUD), 统计查询, 标签 (CRUD), 退信列表 (CRUD), 取消订阅列表 (CRUD) 等功能. 

用户只需要选择熟悉的开发语言, 实现客户程序, 就可以方便地和 SendCloud 进行通信.

### 验证信息

* API_USER

    * API_USER 是调用接口发信时的帐号

    * 创建 API_USER 时, 你需要指定其「类型」(触发/批量), 「发信域名」, 「追踪选项」

    * 类型: 「触发类型」的 API_USER 只能发送触发邮件, 「批量类型」的 API_USER 只能发送批量邮件

    * 发信域名: 配置之后, 使用此 API_USER 发信的发信域名就被确定了

    * 追踪选项: 选择之后, 使用此 API_USER 发信, SendCloud 可以帮助用户收集接收者相应的追踪信息

    * 使用测试 API_USER 发信, 每天的上限是200封, 即使是收费用户

* API_KEY

    * API_KEY 是调用接口发信时的密码
 
    * 注册成功后, SendCloud 会生成 API_KEY, 并发送至你的注册邮箱

    * API_KEY 可以重置, 重置之后立即生效

    * 所有 API_USER 共用一个 API_KEY


## 基础

### 发信域名

发信域名是一封邮件的出处. 在 smtp 会话过程中, 即是 mail from 的后缀

    mail from: test@liubida.cn
    250 sender test@liubida.cn OK

此时, *liubida.com* 就是这封邮件的发信域名. 发信域名的概念很重要, 因为很多 ESP ( 邮件服务器 ) 就是根据发信域名来确定*发信的频度*, *每天发信的数量*等重要指标的.

SendCloud 为新用户生成了「测试域名」, 方便用户测试发送. 

    测试域名的命名规则: '随机串.sendcloud.org'.

当用户正式接入服务时, 需要在 SendCloud 平台上配置自己的发信域名

* 正式接入 SendCloud 平台的用户, 应该拥有自己服务的域名 ( 比如liubida.cn )
* 你也可以使用 liubida.cn 的子域来作为自己的发信域名 ( 比如push.liubida.cn )

通过`【设置】-【域名】-【新增发信域名】`来创建自己的发信域名
***

**使用测试域名: W0YoeJHepAzA7v1JDuG6e8reehqEuPoP.sendcloud.org 发送的邮件**
![pic](../resources/domain_test.png)

* 前缀: beb31150-bef0-11e4-9dbb-00163e15002f
* 发信域名: W0YoeJHepAzA7v1JDuG6e8reehqEuPoP.sendcloud.org
* mail from的组成: 前缀@发信域名 (beb31150-bef0-11e4-9dbb-00163e15002f@W0YoeJHepAzA7v1JDuG6e8reehqEuPoP.sendcloud.org)
* 使用测试域名发信, 每天的上限是200封, 即使是收费用户

***

**使用自有域名 ( 自己创建的域名 ) : push.liubida.cn 发送的邮件**
![pic](../resources/domain_liubida.cn.png)

* 前缀: 98a47302-beee-11e4-a3b9-00163e12fa99
* 发信域名: push.liubida.cn
* mail from的组成: 前缀@发信域名(98a47302-beee-11e4-a3b9-00163e12fa99@push.liubida.cn)

    [为什么会有代发?](#jump_daifa)

### 发信域名配置

创建发信域名之后, 需要完成必要的配置, 才能使用其进行发信. 这些配置项是保证域名能够优质出信的基础, 如果使用未配置的域名发信, 出信量和到达率都会很糟糕.

* **VERIFY_KEY** ( 必配 )

VERIFY_KEY 是 SendCloud 分配给每个账户的域名唯一标示, 防止域名被其他账户盗用

* **SPF** ( 必配 )  [wiki解释](http://zh.wikipedia.org/wiki/Sender_Policy_Framework)

SPF 是为了防范垃圾邮件而提出来的一种 DNS 记录类型, 用于登记某个域名拥有的外发邮件的所有 IP 地址

* **MX** ( 必配 )

MX 是邮件交换记录, 它指向一个邮件服务器, 用于电子邮件系统发邮件时根据收信人的地址后缀来定位邮件服务器

<span id="jump_cname"></span>

* **CNAME**

CNAME 是链接跳转记录. SendCloud 需要此配置来收集点击数据. 
此项是选配项. 如果不配置, SendCloud 只能为你收集打开和退订数据. 只有在配置此项之后, SendCloud 才能为你收集用户的所有反馈信息 ( 打开, 点击和退订 ).

* **DKIM**  [wiki解释](http://zh.wikipedia.org/wiki/DKIM)

DKIM 是防止欺诈邮件的一个重要技术手段, 通常发送方会在电子邮件的标头插入 DKIM-Signature 及电子签名资讯, 而接收方则透过 DNS 查询得到公钥后进行验证. 建议配置, 特别是国外域比较多的用户.

**正是因为发信域名如此的重要, 所以 SendCloud 要求收费用户必须创建自己的发信域名, 并且完成配置, 才能正式接入**

### 样本审核 (sample)

为了防止用户利用 SendCloud 平台发送色情, 欺诈等非法邮件, SendCloud 要求用户将每次发送的邮件内容提交审核. 流程如下:

* 用户将邮件内容复制, 创建样本, 并提交审核
* 样本审核通过之后, 用户就可以发送此类邮件

SendCloud 在接收客户邮件之后, 会对邮件和样本进行匹配. 只要能成功匹配一个样本, 既验证通过. 否则, 用户会收到 `553 sample_validate not match` 的错误提示.

邮件和样本匹配的要素有如下几点:

1. 发送邮件时使用的 API_USER 的类型 ( 触发/批量 ) 和样本的类型 ( 触发/批量 )  一致
2. 邮件的附件个数和样本中声明的附件个数 一致
3. 邮件中图片个数和样本中的图片个数 一致
4. 邮件中每张图片的内容和样本中相应图片的内容 一致 ( 如果修改图片内容, 请重新提交审核 )
5. 邮件中文本内容和样本文本内容达到一定比例的匹配, 容许两者有差异

对于大多数用户来说, 每封邮件的差异性不大, 所以样本审核没有问题. 

但是, 如果你发送的邮件差异性很大, 那样本审核就有可能给你带来困扰. 如果你遇到此问题, 请在系统中提交工单, 会有同学为你解决此问题.

### 用户操作 

#### 当天请求额度

用户每天能够请求的额度值, 即每天能够发送给 SendCloud 的最大邮件数量. 超过此值时, 用户会收到 `Request quota exceeded` 的错误提示.

注意: SendCloud 当天成功接收的邮件请求, 并不一定能够在当天发送完毕. 部分邮件可能会处于发送 - 暂停 - 发送 - 暂停的状态, 这样的「队列状态」可能会持续数日. TODO: 详细见: 队列状态

#### 信誉度

用户在 SendCloud 平台的信誉评分. 「信誉度」和「当天请求额度」是高度正相关的两个数值. 当信誉度小于 0 时, 当天请求额度为 0 .

此评分是由 SendCloud 根据用户的邮件发送数据实时计算出来的, 优质的「送达率」,「打开率」,「点击率」会促成加分, 大量的「无效地址」,「垃圾举报」,「取消订阅」则会促成减分.

注意: 短时间内「无效地址」,「垃圾举报」的激增会直接导致信誉度减为 0 , 用户无法继续请求.

#### 用户认证

用户在正式接入 SendCloud 之前, 必须完成一些信息的认证. 这些认证的目的是为了防止不法分子利用 SendCloud 平台发送垃圾邮件.

* 完善信息: 此项认证需要填写企业相关信息.

* 网站认证: 此项认证需要你为「商业网站」的域名添加一条指定的TXT记录.

* 商业认证: 此项认证需要你提供「营业执照」,「组织机构代码证」,「税务登记证」.

>     SendCloud 平台希望用户接入之前, 已经完成商业网站的域名申请和备案. 
>     「网站认证」的ICP备案信息和「商业认证」的公司信息, 两者需要一致.
>     没有商业网站域名的用户, 不能升级成付费用户.

## 高级

### 邮件追踪 (track)

邮件追踪能够帮助用户收集已发出邮件的「打开数据」,「点击数据」,「退订数据」, 以此来评估邮件发送的效果.

你可以通过`【设置】-【追踪选项】`来配置某个「API_USER」的「打开追踪」,「点击追踪」,「订阅追踪」.

注意: 「点击追踪」依赖于用户发信域名的[CNAME 配置](#jump_cname)

### 地址列表

地址列表是一个方便用户发送邮件的功能. 用户编辑/导入地址列表后, 在请求接口时, 不需要再传输邮件地址, 只需在参数中指定地址列表的「别称地址」即可.

用户可以通过`【发送相关】-【地址列表】`来创建【地址列表】

注意: 

1. 只有通过 WEBAPI 的方式发送邮件, 才支持使用地址列表
2. 只有使用 「批量类型」的 API_USER 调用接口, 才支持使用地址列表
3. 只有付费用户才支持使用地址列表

### 邮件模板 (template)

邮件模板是另一个方便用户发送邮件的功能. 用户编辑/上传邮件模板后, 在请求接口时, 不需要再传输邮件内容, 只需在参数中指定模板的「调用名称」即可.

模板中可以定义「变量」, 变量的使用方法:

* 编辑模板时, 使用「变量」来占位邮件的部分内容
* 请求接口时, 在参数中指定「变量的值」. SendCloud 会用「变量的值」替换「变量」.

用户可以通过`【发送相关】-【邮件模板】`来创建【邮件模板】

### 标签 (tag)

标签能够帮助用户对邮件进行分类, 适用于 A/B 测试等场景.

>     给2种风格的邮件赋予不同的标签进行测试发送, 通过标签分别查看2种风格邮件的打开/点击数据
>     就能知道接收者最喜欢哪种邮件了~

注意: 每封邮件只能使用一个标签

### 收信路由 

如果你能收到你的用户的回信, 那真是一件让人激动的事情, 所以, SendCloud 为你准备了这个贴心的功能.

![pic](../resources/mx.png)

此功能就是把用户回复到某地址的邮件转发给你设置的邮箱, 或是你设置的某个URL. 你可以接收邮件数据, 再做后续处理.

你可以通过`【设置】-【域名】- 【选择某域名】- 【收信配置】- 【收信路由】` 来配置此功能.

### WebHook

请求发送给 SendCloud 之后, SendCloud 会把「请求结果」同步返回给用户, 而邮件的「发送结果」是通过 WebHook 异步返回给用户的.

WebHook 机制: 

* SendCloud 为客户提供了一些邮件事件, 客户可以选择关注某些事件
* 当某事件发生, 就会触发 SendCloud 向客户设置的 URL 发送数据
* 客户收到数据, 解析出事件和数据, 做后续的处理

目前 SendCloud 支持的邮件事件如下:

  TODO: xuhong 帮忙做一个table

  |事件                 |触发条件         |
  |---------------------|---------------  |
  |请求(request)        |邮件请求成功     |
  |发送(deliver)        |邮件发送成功     |
  |打开(open)           |用户打开邮件     |
  |点击(click)          |用户点击链接     |
  |退订(unsubscribe)    |用户退订邮件     |
  |退信(bounce)         |邮件被拒绝       |
  |邮件举报(report_spam)|用户举报邮件     |
  |无效邮件(invalid)    |邮件被判定无效   |


你可以通过`【设置】-【WebHook】` 来选择关注的事件, 配置接收数据的URL.

### 订阅入口

订阅入口的作用是帮助用户创建, 维护和用户的订阅关系.

SendCloud 和 ESP 都在推进建立用户和用户订阅关系, 也会大力支持这种存在订阅关系的邮件发送 ( 比如 QQ邮件列表 ).

1. SendCloud 为用户生成一个「订阅入口」:
![pic](../resources/subscribe_dingyue.png)

2. 用户将此入口放置在自己的网站中

3. 用户在「订阅入口」输入邮箱地址, 申请订阅此网站的文章

4. 用户收到确认邮件, 确认订阅操作

5. 用户的邮箱地址自动加入用户的某个「地址列表」.

6. 这样, 用户就完成了和用户的订阅关系

此功能依赖于「地址列表」, 用户点击某个「地址列表」的「订阅样式」, 就可以进入配置页面.

## FAQ

### 1. 如何理解 mail from, from, reply-to?

mail_from: 信封上的发件人. 由「前缀@域名」组成. 它的域名就是所谓的「发信域名」.
 
from: 信件内容里的发件人. 用户可以任意填写, 支持别名显示.

    String from = MimeUtility.encodeText("爱发信客服", "UTF-8", "B") + \
                  "<support@ifaxin.com>";

「代发」是否出现, 就是看 *mail_from* 和 *from* 是否相同.

reply-to: 信件回复的收件人. 用户直接回复邮件时, *reply-to* 就是默认的收件人. 如果用户不指定它, *from* 就是默认的收件人.

<span id="jump_daifa"></span>
### 2. 为什么会有代发?

邮件中存在 *mail_from* 和 *from* 两个概念.  如果这两者不一致, 则 ESP 会在客户端上显示代发, 用以提醒收件人.

![pic](../resources/domain_liubida.cn.png)

如果两者一致, 则不会显示代发.

![pic](../resources/domain_push.liubida.cn.png)

当然, 有些 ESP 并不会要求这两者的完全一致, 而是只要求两者的域名相同, 就不会显示'代发'. ( 比如 QQ 邮箱 )

由于 SendCloud 对 *mail_from* 的前缀使用的是随机串, 所以, 如果碰到严苛的 ESP ( *mail_from* 和 *from* 必须完全一致才不显示代发, 比如网易邮箱 ), 那也只能爱莫能助了.

如果你对不显示代发有非常强烈的需求, 可以联系我, 帮你再想想办法.

### 3. QQ域被暂停, why?

QQ预热机制

